<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{layout}" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
	<style>
		.stdlog { max-height: 400px }
	</style>
</head>

<body>
<div layout:fragment="content">
	<div th:replace="stepper :: stepper(step = 3)"></div>
	<div th:replace="talk_header :: talk_header(talk = ${talk}, link = @{/020-record})"></div>

	<div id="vue">
		<div v-if="this.ffmpegState !== 'NOT_STARTED'">
			<div class="row mb-3">
				<div class="col-md-6">
					<h4 v-if="this.ffmpegState === 'RUNNING'">Export en cours...</h4>
					<h4 v-if="this.ffmpegState === 'DONE'">Export terminé</h4>
				</div>
				<div class="col-md-6">
					<p v-if="remaining && this.ffmpegState === 'RUNNING'" class="text-muted font-italic text-right">
						Temps restant estimé : {{ remaining | duration().format('h [h] m [min] s [s]') }}
					</p>
				</div>
			</div>

			<div class="row mb-3">
				<div class="col-md-12">
					<div class="progress pgbar">
						<div class="progress-bar" role="progressbar"
							 v-bind:class="progressBarStyle" v-bind:style="{ width: progress + '%' }" >
							{{progress}}%
						</div>
					</div>
				</div>
			</div>

			<div class="row mt-5 mb-5" v-if="this.ffmpegState === 'DONE'">
				<div class="col text-center">
					<div><a th:href="@{/010-talk-choice}" class="btn btn-primary btn-lg" v-pad-click="13">
						Relancer une captation <i class="pad pad-13"></i></a></div>
				</div>

				<div class="col text-center">
					<button class="btn btn-secondary btn-lg" @click="shutdown" v-pad-click="16">
						Éteindre le PC <i class="pad pad-16"></i></button>
				</div>
			</div>
		</div>

		<div  v-if="this.ffmpegState === 'NOT_STARTED'" class="row mb-3">
			<div class="col-sm jumbotron jumbo-light">
				<p class="text-center mb-4">
                    Veuillez sélectionner la <strong>destination de l'export</strong>.<br>
					Taille à copier : <strong>{{size | formatBytes}}</strong>
					<i>(Durée de la vidéo : {{ duration | duration().format('h [h] m [min] s [s]') }})</i>
				</p>

                <div id="cards">
                    <div class="row" v-for="i in Math.ceil(drives.length / 4)">
                        <div class="col-sm-3" v-for="(d, idx) in drives.slice((i - 1) * 4, i * 4)">
                            <div class="card">
                                <div>
                                    <div class="card-body">
                                        <h5 class="card-title" v-if="!d.label">{{d.vendor}} {{d.model}}</h5>
										<h5 class="card-title mb-1" v-if="d.label">{{d.label}}</h5>
                                        <h5 class="card-subtitle mb-2" v-if="d.label">{{d.vendor}} {{d.model}}</h5>

                                        <h6 class="card-subtitle mb-1 text-muted">{{d.deviceName}}</h6>
                                        <h6 class="card-subtitle mb-2 text-muted">{{d.mountpoint}}</h6>

                                        <p v-if="d.size">Espace total : {{d.size}}</p>
                                        <p class="mb-2">
											Espace libre : {{d.spaceLeft | formatBytes}}
											<i class="fas fa-exclamation-circle" v-if="d.spaceLeft < size"></i>
											<i class="far fa-check-circle" v-if="d.spaceLeft > size"></i>
										</p>

                                        <button @click="selCopy(d)" class="btn"
												:class="{ 'btn-primary': d.mountpoint != selMnt, 'btn-success': d.mountpoint == selMnt }">
											<i class="far fa-check-circle" v-if="d.mountpoint == selMnt"></i>
											Exporter ici
										</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

				<p class="text-center">
					<button class="btn btn-primary btn-lg btn-block mt-4" :disabled="!selMnt" @click="startExport()">Lancer l'export</button>
				</p>
			</div>
		</div>

		<div class="row mb-3" v-if="log.length > 0">
			<div class="col-sm-12">
				<pre class="pre-scrollable stdlog" ref="logPre">
{{log.join('\n')}}
				</pre>
			</div>
		</div>
	</div>

	<script>
        moment.locale('fr')
		Vue.use(vueMoment, { moment })
		new Vue({
			el: '#vue',
			data: {
				log: [],
				ffmpegState: 'NOT_STARTED',
				progress: 0,
				duration: 0,
				size: 0,
				remaining: null,
                drives: [],
				selMnt: null
			},

			created() {
				this.loadInfos()
				this.connectToWS()
                this.loadDrives()
			},

			computed: {
				progressBarStyle() {
					return {
						'progress-bar-animated': this.ffmpegState === 'RUNNING',
						'progress-bar-striped': this.ffmpegState === 'RUNNING',
						'bg-info': this.ffmpegState === 'NOT_STARTED',
						'bg-success': this.ffmpegState === 'DONE'
					}
				}
			},

			methods: {
				loadInfos() {
					axios.get('/export/infos').then(res => {
						let exportStartInfos = res.data;
						this.duration = moment.duration(exportStartInfos.filesLength).asMilliseconds()
						this.size = exportStartInfos.filesSize
					})
				},

				connectToWS() {
					ws.sub('/030-ffmpeg-export-out', msg => {
						let body = msg.body
						if (body === '---- NEW STREAM ----') {
							this.log = []
							this.ffmpegState = 'RUNNING'

						} else if (body === 'ffmpeg stopped and returned [0]') {
							this.progress = 100
							this.ffmpegState = 'DONE'
						}

						this.log.push(body)

						//limit number of lines
						if (this.log.length > 100) {
							this.log.splice(0, this.log.length - 100)
						}

						//scroll log at bottom
						let log = this.$refs.logPre
						if (log) log.scrollTop = log.scrollHeight

					}).sub('/030-ffmpeg-export-progress', msg => {
						let progress = JSON.parse(msg.body)
						this.progress = Math.round(progress.outTimeUs / this.duration / 10) //us -> ms /1000 - percent -> *100
						let remainMs = (this.duration - progress.outTimeUs / 1000) / progress.speed
						this.remaining = moment.duration(remainMs)
					})
				},

                loadDrives() {
					if (this.ffmpegState !== 'NOT_STARTED') return

                    axios.get('/files/removable').then(res => {
                        this.drives = res.data
                        setTimeout(() => this.loadDrives(), 1000)
                    })
                },

				selCopy(drive) {
					if (this.selMnt !== drive.mountpoint) {
						this.selMnt = drive.mountpoint
					} else {
						//unselect
						this.selMnt = null
					}
				},

				startExport() {
					this.ffmpegState = 'RUNNING'
					let data = new FormData()
					data.set('dir', this.selMnt)
					axios.post('/export/start', data)
				},

				shutdown() {
					axios.post('/copy/shutdown')
				}
			}
		})
	</script>

</div>
</body>
</html>