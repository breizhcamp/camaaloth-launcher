<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <script src="/webjars/axios/0.18.0/dist/axios.min.js"></script>
    <script src="/webjars/moment/2.24.0/min/moment-with-locales.min.js"></script>
    <script src="/webjars/vue-moment/4.0.0/dist/vue-moment.min.js"></script>
    <script src="/webjars/moment-duration-format/2.2.2/lib/moment-duration-format.js"></script>
    <script src="/webjars/vue/2.5.17/dist/vue.js" ></script>
    <script src="/static/js/lib.js" th:src="@{/js/lib.js}"></script>
    <script src="/static/js/filters.js" th:src="@{/js/filters.js}"></script>

    <style>
        .stdlog { max-height: 500px }
    </style>
</head>

<body>
<div layout:fragment="content">
    <div th:replace="stepper :: stepper(step = 5)"></div>

    <div id="vue">
        <div class="row mb-3" v-if="files.length > 0">
            <h4>Fichiers en attente de copie :</h4>
            <table class="table">
                <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Fichier</th>
                    <th scope="col">Taille</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="(f, idx) in files" :class="{ 'table-active': f.selected }" @click="selectFile(f)">
                    <td>{{ idx + 1 }}</td>
                    <td>{{ f.name }}</td>
                    <td>{{ f.size | formatBytes }}</td>
                </tr>
                </tbody>
            </table>
        </div>

        <div class="row mb-3" v-if="log.length > 0">
            <div class="col-sm-12">
				<pre class="pre-scrollable stdlog" ref="logPre">
{{log.join('\n')}}
				</pre>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#vue',
            data: {
                log: [],
                files: []
            },

            created() {
                this.loadFiles()
                this.connectToWS()
            },

            methods: {
                connectToWS() {
                    ws.sub('/050-copy-out', msg => {
                        let body = msg.body
                        this.log.push(body)

                        //limit number of lines
                        if (this.log.length > 100) {
                            this.log.splice(0, this.log.length - 100)
                        }

                        //scroll log at bottom
                        let log = this.$refs.logPre;
                        if (log) log.scrollTop = log.scrollHeight;
                    })
                },

                loadFiles() {
                    axios.get('/copy/waiting').then(res => {
                        this.files = res.data
                    })
                }
            }
        })
    </script>
</div>
</body>
</html>